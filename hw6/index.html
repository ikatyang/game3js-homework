<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <title>Game3js Homework6</title>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.5.1/dat.gui.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/three.js/r81/three.min.js'></script>
    <script src='../src/OrbitControls.js'></script>
    <style>
      body {
      	margin: 0;
      	overflow: hidden;
      }
      .top {
      	position: absolute;
      	width: 100%;
      	padding: 10px;
      	text-align: center;
      	top: 1em;
      	color: yellow;
      }
    </style>
  </head>
  <body>
    <div class='top'>GP_HW6</div>
    <script>
      var scene, camera, renderer, controls;
      var clock = new THREE.Clock();
      var character, skeletonHelper;
      
      init();
      animate();
      
      function init() {
      	scene = new THREE.Scene();
      
      	camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1, 10000);
      	camera.position.set(0, 500, 500);
      
      	renderer = new THREE.WebGLRenderer();
      	renderer.setSize(window.innerWidth, window.innerHeight);
      	renderer.setClearColor(0x888888);
      	document.body.appendChild(renderer.domElement);
      	
      	controls = new THREE.OrbitControls(camera, renderer.domElement);
      	window.addEventListener('resize', onWindowResize, false);
      	
      	var gridXZ = new THREE.GridHelper(200, 20, 0xff0000, 0xffffff);
      	scene.add(gridXZ);
      	
      	var light = new THREE.HemisphereLight(0xffffbb, 0x080820, 1);
      	scene.add(light);
      	
      	character = createCharacter();
      	scene.add(character);
      	
      	skeletonHelper = new THREE.SkeletonHelper(character);
      	scene.add(skeletonHelper);
      }
      
      function onWindowResize() {
      	camera.aspect = window.innerWidth / window.innerHeight;
      	camera.updateProjectionMatrix();
      	renderer.setSize(window.innerWidth, window.innerHeight);
      }
      
      function animate() {
      
      	var delta = clock.getDelta();
      	
      	skeletonHelper.update();
      	controls.update();
      	requestAnimationFrame(animate);
      	renderer.render(scene, camera);
      }
      
      function createCharacter() {
      
      	var geometry = new THREE.Geometry();
      	var material = new THREE.MeshPhongMaterial({ skinning: true, color: 0xff1234 });
      	
      	var character = new THREE.SkinnedMesh(geometry, material);
      	initCharacter(character);
      	
      	return character;
      }
      
      function initCharacter(character) {
      	
      	var bodyWidth = 30;
      	var bodyHeight = 40;
      	var bodyDepth = 20;
      	
      	var thighGap = bodyWidth * 0.5;
      	var thighRadius = 6;
      	var thighLength = 30;
      	
      	var calfRadius = 4;
      	var calfLength = 30;
      	
      	var upperarmRadius = 4;
      	var upperarmLength = 20;
      	
      	var forearmRadius = 3;
      	var forearmLength = 20;
      	
      	var bones = [];
      	
      	var root = new THREE.Bone();
      	root.name = 'Root';
      	bones.push(root);
      	
      		var sacrum = new THREE.Bone();
      		sacrum.name = 'Sacrum';
      		root.add(sacrum);
      		bones.push(sacrum);
      		
      			var leftHip = new THREE.Bone();
      			leftHip.name = 'LeftHip';
      			leftHip.position.x = thighGap * 0.5;
      			sacrum.add(leftHip);
      			bones.push(leftHip);
      		
      			var rightHip = new THREE.Bone();
      			rightHip.name = 'RightHip';
      			rightHip.position.x = thighGap * -0.5;
      			sacrum.add(rightHip);
      			bones.push(rightHip);
      			
      				var leftFemur = new THREE.Bone();
      				leftFemur.name = 'LeftFemur';
      				leftFemur.position.y = thighLength * -1;
      				leftHip.add(leftFemur);
      				bones.push(leftFemur);
      			
      				var rightFemur = new THREE.Bone();
      				rightFemur.name = 'RightFemur';
      				rightFemur.position.y = thighLength * -1;
      				rightHip.add(rightFemur);
      				bones.push(rightFemur);
      				
      					var leftTibia = new THREE.Bone();
      					leftTibia.name = 'LeftTibia';
      					leftTibia.position.y = calfLength * -1;
      					leftFemur.add(leftTibia);
      					bones.push(leftTibia);
      				
      					var rightTibia = new THREE.Bone();
      					rightTibia.name = 'RightTibia';
      					rightTibia.position.y = calfLength * -1;
      					rightFemur.add(rightTibia);
      					bones.push(rightTibia);
      		
      		var manubrium = new THREE.Bone();
      		manubrium.name = 'Manubrium';
      		manubrium.position.y = bodyHeight - upperarmRadius;
      		sacrum.add(manubrium);
      		bones.push(manubrium);
      		
      			var leftClavicle = new THREE.Bone();
      			leftClavicle.name = 'LeftClavicle';
      			leftClavicle.position.x = bodyWidth * 0.5;
      			manubrium.add(leftClavicle);
      			bones.push(leftClavicle);
      		
      			var rightClavicle = new THREE.Bone();
      			rightClavicle.name = 'RightClavicle';
      			rightClavicle.position.x = bodyWidth * -0.5;
      			manubrium.add(rightClavicle);
      			bones.push(rightClavicle);
      			
      				var leftHumerus = new THREE.Bone();
      				leftHumerus.name = 'LeftHumerus';
      				leftHumerus.position.x = upperarmLength * 1;
      				leftClavicle.add(leftHumerus);
      				bones.push(leftHumerus);
      			
      				var rightHumerus = new THREE.Bone();
      				rightHumerus.name = 'RightHumerus';
      				rightHumerus.position.x = upperarmLength * -1;
      				rightClavicle.add(rightHumerus);
      				bones.push(rightHumerus);
      				
      					var leftUlna = new THREE.Bone();
      					leftUlna.name = 'LeftUlna';
      					leftUlna.position.x = forearmLength * 1;
      					leftHumerus.add(leftUlna);
      					bones.push(leftUlna);
      				
      					var rightUlna = new THREE.Bone();
      					rightUlna.name = 'RightUlna';
      					rightUlna.position.x = forearmLength * -1;
      					rightHumerus.add(rightUlna);
      					bones.push(rightUlna);
      	
      	// body
      	addGeometry(new THREE.BoxGeometry(bodyWidth, bodyHeight, bodyDepth), function (vertex) {
      		
      		return [
      			new THREE.Vector4(bones.indexOf(sacrum), 0, 0, 0),
      			new THREE.Vector4(1, 0, 0, 0)];
      			
      	}, new THREE.Matrix4().compose(
      		new THREE.Vector3(0, bodyHeight * 0.5, 0),
      		new THREE.Quaternion().setFromEuler(new THREE.Euler(0, 0, 0, 'XYZ')),
      		new THREE.Vector3(1, 1, 1)
      	));
      	
      	// left-thigh
      	addGeometry(new THREE.SphereGeometry(thighRadius), function (vertex) {
      		
      		return [
      			new THREE.Vector4(bones.indexOf(leftHip), 0, 0, 0),
      			new THREE.Vector4(1, 0, 0, 0)];
      			
      	}, new THREE.Matrix4().compose(
      		new THREE.Vector3(thighGap * 0.5, 0, 0),
      		new THREE.Quaternion().setFromEuler(new THREE.Euler(0, 0, 0, 'XYZ')),
      		new THREE.Vector3(1, 1, 1)
      	));
      	addGeometry(new THREE.CylinderGeometry(thighRadius, calfRadius, thighLength), function (vertex) {
      		
      		return [
      			new THREE.Vector4(bones.indexOf(leftHip), 0, 0, 0),
      			new THREE.Vector4(1, 0, 0, 0)];
      			
      	}, new THREE.Matrix4().compose(
      		new THREE.Vector3(thighGap * 0.5, thighLength * -0.5, 0),
      		new THREE.Quaternion().setFromEuler(new THREE.Euler(0, 0, 0, 'XYZ')),
      		new THREE.Vector3(1, 1, 1)
      	));
      	
      	// right-thigh
      	addGeometry(new THREE.SphereGeometry(thighRadius), function (vertex) {
      		
      		return [
      			new THREE.Vector4(bones.indexOf(rightHip), 0, 0, 0),
      			new THREE.Vector4(1, 0, 0, 0)];
      			
      	}, new THREE.Matrix4().compose(
      		new THREE.Vector3(thighGap * -0.5, 0, 0),
      		new THREE.Quaternion().setFromEuler(new THREE.Euler(0, 0, 0, 'XYZ')),
      		new THREE.Vector3(1, 1, 1)
      	));
      	addGeometry(new THREE.CylinderGeometry(thighRadius, calfRadius, thighLength), function (vertex) {
      		
      		return [
      			new THREE.Vector4(bones.indexOf(rightHip), 0, 0, 0),
      			new THREE.Vector4(1, 0, 0, 0)];
      			
      	}, new THREE.Matrix4().compose(
      		new THREE.Vector3(thighGap * -0.5, thighLength * -0.5, 0),
      		new THREE.Quaternion().setFromEuler(new THREE.Euler(0, 0, 0, 'XYZ')),
      		new THREE.Vector3(1, 1, 1)
      	));
      	
      	// left-calf
      	addGeometry(new THREE.SphereGeometry(calfRadius), function (vertex) {
      		
      		return [
      			new THREE.Vector4(bones.indexOf(leftFemur), 0, 0, 0),
      			new THREE.Vector4(1, 0, 0, 0)];
      			
      	}, new THREE.Matrix4().compose(
      		new THREE.Vector3(thighGap * 0.5, thighLength * -1, 0),
      		new THREE.Quaternion().setFromEuler(new THREE.Euler(0, 0, 0, 'XYZ')),
      		new THREE.Vector3(1, 1, 1)
      	));
      	addGeometry(new THREE.CylinderGeometry(calfRadius, calfRadius, calfLength), function (vertex) {
      		
      		return [
      			new THREE.Vector4(bones.indexOf(leftFemur), 0, 0, 0),
      			new THREE.Vector4(1, 0, 0, 0)];
      			
      	}, new THREE.Matrix4().compose(
      		new THREE.Vector3(thighGap * 0.5, thighLength * -1 + calfLength * -0.5, 0),
      		new THREE.Quaternion().setFromEuler(new THREE.Euler(0, 0, 0, 'XYZ')),
      		new THREE.Vector3(1, 1, 1)
      	));
      	
      	// right-calf
      	addGeometry(new THREE.SphereGeometry(calfRadius), function (vertex) {
      		
      		return [
      			new THREE.Vector4(bones.indexOf(rightFemur), 0, 0, 0),
      			new THREE.Vector4(1, 0, 0, 0)];
      			
      	}, new THREE.Matrix4().compose(
      		new THREE.Vector3(thighGap * -0.5, thighLength * -1, 0),
      		new THREE.Quaternion().setFromEuler(new THREE.Euler(0, 0, 0, 'XYZ')),
      		new THREE.Vector3(1, 1, 1)
      	));
      	addGeometry(new THREE.CylinderGeometry(calfRadius, calfRadius, calfLength), function (vertex) {
      		
      		return [
      			new THREE.Vector4(bones.indexOf(rightFemur), 0, 0, 0),
      			new THREE.Vector4(1, 0, 0, 0)];
      			
      	}, new THREE.Matrix4().compose(
      		new THREE.Vector3(thighGap * -0.5, thighLength * -1 + calfLength * -0.5, 0),
      		new THREE.Quaternion().setFromEuler(new THREE.Euler(0, 0, 0, 'XYZ')),
      		new THREE.Vector3(1, 1, 1)
      	));
      	
      	// left-upperarm
      	addGeometry(new THREE.SphereGeometry(upperarmRadius), function (vertex) {
      		
      		return [
      			new THREE.Vector4(bones.indexOf(leftClavicle), 0, 0, 0),
      			new THREE.Vector4(1, 0, 0, 0)];
      			
      	}, new THREE.Matrix4().compose(
      		new THREE.Vector3(bodyWidth * 0.5, bodyHeight - upperarmRadius, 0),
      		new THREE.Quaternion().setFromEuler(new THREE.Euler(0, 0, 0, 'XYZ')),
      		new THREE.Vector3(1, 1, 1)
      	));
      	addGeometry(new THREE.CylinderGeometry(upperarmRadius, forearmRadius, upperarmLength), function (vertex) {
      		
      		return [
      			new THREE.Vector4(bones.indexOf(leftClavicle), 0, 0, 0),
      			new THREE.Vector4(1, 0, 0, 0)];
      			
      	}, new THREE.Matrix4().compose(
      		new THREE.Vector3(bodyWidth * 0.5 + upperarmLength * 0.5, bodyHeight - upperarmRadius, 0),
      		new THREE.Quaternion().setFromEuler(new THREE.Euler(0, 0, Math.PI * 0.5, 'XYZ')),
      		new THREE.Vector3(1, 1, 1)
      	));
      	
      	// right-upperarm
      	addGeometry(new THREE.SphereGeometry(upperarmRadius), function (vertex) {
      		
      		return [
      			new THREE.Vector4(bones.indexOf(rightClavicle), 0, 0, 0),
      			new THREE.Vector4(1, 0, 0, 0)];
      			
      	}, new THREE.Matrix4().compose(
      		new THREE.Vector3(bodyWidth * -0.5, bodyHeight - upperarmRadius, 0),
      		new THREE.Quaternion().setFromEuler(new THREE.Euler(0, 0, 0, 'XYZ')),
      		new THREE.Vector3(1, 1, 1)
      	));
      	addGeometry(new THREE.CylinderGeometry(upperarmRadius, forearmRadius, upperarmLength), function (vertex) {
      		
      		return [
      			new THREE.Vector4(bones.indexOf(rightClavicle), 0, 0, 0),
      			new THREE.Vector4(1, 0, 0, 0)];
      			
      	}, new THREE.Matrix4().compose(
      		new THREE.Vector3(bodyWidth * -0.5 + upperarmLength * -0.5, bodyHeight - upperarmRadius, 0),
      		new THREE.Quaternion().setFromEuler(new THREE.Euler(0, 0, Math.PI * -0.5, 'XYZ')),
      		new THREE.Vector3(1, 1, 1)
      	));
      	
      	// left-forearm
      	addGeometry(new THREE.SphereGeometry(forearmRadius), function (vertex) {
      		
      		return [
      			new THREE.Vector4(bones.indexOf(leftHumerus), 0, 0, 0),
      			new THREE.Vector4(1, 0, 0, 0)];
      			
      	}, new THREE.Matrix4().compose(
      		new THREE.Vector3(bodyWidth * 0.5 + upperarmLength * 1, bodyHeight - upperarmRadius, 0),
      		new THREE.Quaternion().setFromEuler(new THREE.Euler(0, 0, 0, 'XYZ')),
      		new THREE.Vector3(1, 1, 1)
      	));
      	addGeometry(new THREE.CylinderGeometry(forearmRadius, forearmRadius, forearmLength), function (vertex) {
      		
      		return [
      			new THREE.Vector4(bones.indexOf(leftHumerus), 0, 0, 0),
      			new THREE.Vector4(1, 0, 0, 0)];
      			
      	}, new THREE.Matrix4().compose(
      		new THREE.Vector3(bodyWidth * 0.5 + upperarmLength * 1 + forearmLength * 0.5, bodyHeight - upperarmRadius, 0),
      		new THREE.Quaternion().setFromEuler(new THREE.Euler(0, 0, Math.PI * 0.5, 'XYZ')),
      		new THREE.Vector3(1, 1, 1)
      	));
      	
      	// right-forearm
      	addGeometry(new THREE.SphereGeometry(forearmRadius), function (vertex) {
      		
      		return [
      			new THREE.Vector4(bones.indexOf(rightHumerus), 0, 0, 0),
      			new THREE.Vector4(1, 0, 0, 0)];
      			
      	}, new THREE.Matrix4().compose(
      		new THREE.Vector3(bodyWidth * -0.5 + upperarmLength * -1, bodyHeight - upperarmRadius, 0),
      		new THREE.Quaternion().setFromEuler(new THREE.Euler(0, 0, 0, 'XYZ')),
      		new THREE.Vector3(1, 1, 1)
      	));
      	addGeometry(new THREE.CylinderGeometry(forearmRadius, forearmRadius, forearmLength), function (vertex) {
      		
      		return [
      			new THREE.Vector4(bones.indexOf(rightHumerus), 0, 0, 0),
      			new THREE.Vector4(1, 0, 0, 0)];
      			
      	}, new THREE.Matrix4().compose(
      		new THREE.Vector3(bodyWidth * -0.5 + upperarmLength * -1 + forearmLength * -0.5, bodyHeight - upperarmRadius, 0),
      		new THREE.Quaternion().setFromEuler(new THREE.Euler(0, 0, Math.PI * -0.5, 'XYZ')),
      		new THREE.Vector3(1, 1, 1)
      	));
      	
      	character.add(root);
      	character.bind(new THREE.Skeleton(bones));
      	
      	function addGeometry(geometry, calcSkinParams, matrix) {
      		character.geometry.merge(geometry, matrix);
      		for (var i = 0; i < geometry.vertices.length; i++) {
      			var skinParams = calcSkinParams(geometry.vertices[i], geometry.vertices, i);
      			character.geometry.skinIndices.push(skinParams[0]);
      			character.geometry.skinWeights.push(skinParams[1]);
      		}
      	}
      }
    </script>
  </body>
</html>
